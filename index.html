<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Super-request by doug-martin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Super-request</h1>
      <h2 class="project-tagline">super-request is a supertest inspired HTTP assertion tester.</h2>
      <a href="https://github.com/doug-martin/super-request" class="btn">View on GitHub</a>
      <a href="https://github.com/doug-martin/super-request/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/doug-martin/super-request/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <p><a href="http://travis-ci.org/doug-martin/super-request"><img src="https://secure.travis-ci.org/doug-martin/super-request.png" alt="build status"></a></p>

<h1>
<a id="super-request" class="anchor" href="#super-request" aria-hidden="true"><span class="octicon octicon-link"></span></a>Super Request</h1>

<p><code>super-request</code> is a <a href="https://github.com/visionmedia/supertest"><code>supertest</code></a> inspired HTTP assertion tester.</p>

<h2>
<a id="about" class="anchor" href="#about" aria-hidden="true"><span class="octicon octicon-link"></span></a>About</h2>

<p><code>super-request</code> is very similar to <code>supertest</code> except that it leverages the <a href="https://github.com/mikeal/request"><code>request</code></a> module and supports sessions and chaining of HTTP requests.</p>

<h2>
<a id="installation" class="anchor" href="#installation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installation</h2>

<p><code>npm install super-request</code></p>

<h2>
<a id="example" class="anchor" href="#example" aria-hidden="true"><span class="octicon octicon-link"></span></a>Example</h2>

<div class="highlight highlight-javascript"><pre>
<span class="pl-k">var</span> request <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>super-request<span class="pl-pds">'</span></span>),
    express <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>express<span class="pl-pds">'</span></span>);

<span class="pl-k">var</span> app <span class="pl-k">=</span> express();

app.use(express.cookieParser());
app.use(express.cookieSession({secret<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>super-request123<span class="pl-pds">"</span></span>}));

app.get(<span class="pl-s"><span class="pl-pds">'</span>/login<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> (<span class="pl-smi">req</span>, <span class="pl-smi">res</span>) {
    req.session.loggedIn <span class="pl-k">=</span> <span class="pl-c1">true</span>;
    res.<span class="pl-c1">send</span>(<span class="pl-s"><span class="pl-pds">"</span>logged in<span class="pl-pds">"</span></span>);
});

app.get(<span class="pl-s"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> (<span class="pl-smi">req</span>, <span class="pl-smi">res</span>) {
    <span class="pl-k">if</span> (req.session.loggedIn) {
        req.session.loggedIn <span class="pl-k">=</span> <span class="pl-c1">true</span>;
        res.<span class="pl-c1">send</span>(<span class="pl-s"><span class="pl-pds">"</span>loggedIn<span class="pl-pds">"</span></span>);
    } <span class="pl-k">else</span> {
        res.<span class="pl-c1">send</span>(<span class="pl-s"><span class="pl-pds">"</span>notLoggedIn<span class="pl-pds">"</span></span>);
    }
});

request(app)
    .get(<span class="pl-s"><span class="pl-pds">'</span>/login<span class="pl-pds">'</span></span>)
    .expect(<span class="pl-c1">200</span>, <span class="pl-s"><span class="pl-pds">"</span>logged in<span class="pl-pds">"</span></span>)
    .end()
    <span class="pl-c">//after we logged in perform this request in the same session!</span>
    .get(<span class="pl-s"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>)
    .expect(<span class="pl-c1">200</span>, <span class="pl-s"><span class="pl-pds">"</span>loggedIn<span class="pl-pds">"</span></span>)
    .end(<span class="pl-k">function</span>(<span class="pl-smi">err</span>){
        <span class="pl-k">if</span>(err){
            <span class="pl-k">throw</span> err;
        }
    });</pre></div>

<h2>
<a id="using-with-testing-frameworks" class="anchor" href="#using-with-testing-frameworks" aria-hidden="true"><span class="octicon octicon-link"></span></a>Using with testing frameworks</h2>

<h3>
<a id="mocha" class="anchor" href="#mocha" aria-hidden="true"><span class="octicon octicon-link"></span></a>Mocha</h3>

<p>Here is an example using with <code>mocha</code>.</p>

<div class="highlight highlight-javascript"><pre>describe(<span class="pl-s"><span class="pl-pds">'</span>GET /users<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(){
  it(<span class="pl-s"><span class="pl-pds">'</span>respond with json<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(<span class="pl-smi">done</span>){
    request(app)
      .get(<span class="pl-s"><span class="pl-pds">'</span>/user<span class="pl-pds">'</span></span>)
      .set(<span class="pl-s"><span class="pl-pds">'</span>Accept<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>application/json<span class="pl-pds">'</span></span>)
      .expect(<span class="pl-s"><span class="pl-pds">'</span>Content-Type<span class="pl-pds">'</span></span>,<span class="pl-sr"> <span class="pl-pds">/</span>json<span class="pl-pds">/</span></span>)
      .expect(<span class="pl-c1">200</span>, done);
  })
})</pre></div>

<p><code>super-request</code> also returns a promise so you can use it with promise based test frameworks here is an an example using <code>it</code> and returning a promise.</p>

<div class="highlight highlight-javascript"><pre>
it.describe(<span class="pl-s"><span class="pl-pds">'</span>GET /users<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(<span class="pl-smi">it</span>){
  it.should(<span class="pl-s"><span class="pl-pds">'</span>respond with json<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(){
    <span class="pl-k">return</span> request(app)
        .get(<span class="pl-s"><span class="pl-pds">'</span>/user<span class="pl-pds">'</span></span>)
        .set(<span class="pl-s"><span class="pl-pds">'</span>Accept<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>application/json<span class="pl-pds">'</span></span>)
        .expect(<span class="pl-s"><span class="pl-pds">'</span>Content-Type<span class="pl-pds">'</span></span>,<span class="pl-sr"> <span class="pl-pds">/</span>json<span class="pl-pds">/</span></span>)
        .expect(<span class="pl-c1">200</span>)
        .end();
  });
});
</pre></div>

<h2>
<a id="api" class="anchor" href="#api" aria-hidden="true"><span class="octicon octicon-link"></span></a>API</h2>

<p><strong><code>.expect(status[, fn])</code></strong></p>

<p>Assert response status code.</p>

<p><strong><code>.expect(status, body[, fn])</code></strong></p>

<p>Assert response status code and body.</p>

<p><strong><code>.expect(body[, fn])</code></strong></p>

<p>Assert response body text with a string, regular expression, or parsed body object.</p>

<p><strong><code>.expect(field, value[, fn])</code></strong></p>

<p>Assert header field value with a string or regular expression.</p>

<p><strong><code>.end(fn)</code></strong></p>

<p>Perform the request and invoke fn(err, res).</p>

<p><code>super-request</code> is a wrapper on top of <code>request</code> so any options you can specify with request you can also set using the chainable api, by invoking a function with the same name as the option you wish to set.</p>

<p><strong>Methods</strong> (see <a href="https://github.com/mikeal/request"><code>request</code></a>)</p>

<p>All option methods listed below allow functions to be passed as the argument in place of the default value.  The function must return a valid object, int, string etc. that the option would normally accept.  See the "<a href="#simple-token-auth-example">Simple token-auth example</a>" below.</p>

<ul>
<li>
<code>uri</code> || <code>url</code> - fully qualified uri or a parsed url object from url.parse()</li>
<li>
<code>qs</code> - object containing querystring values to be appended to the uri</li>
<li>
<code>method</code> - http method, defaults to GET</li>
<li>
<code>headers</code> - http headers, defaults to {}</li>
<li>
<code>body</code> - entity body for POST and PUT requests. Must be buffer or string.</li>
<li>
<code>form</code> - when passed an object this will set <code>body</code> but to a querystring representation of value and adds <code>Content-type: application/x-www-form-urlencoded; charset=utf-8</code> header. When passed no option a FormData instance is returned that will be piped to request.</li>
<li>
<code>json</code> - sets <code>body</code> but to JSON representation of value and adds <code>Content-type: application/json</code> header.  Additionally, parses the response body as json.</li>
<li>
<code>multipart</code> - (experimental) array of objects which contains their own headers and <code>body</code> attribute. Sends <code>multipart/related</code> request. See example below.</li>
<li>
<code>followRedirect</code> - follow HTTP 3xx responses as redirects. defaults to true.</li>
<li>
<code>followAllRedirects</code> - follow non-GET HTTP 3xx responses as redirects. defaults to false.</li>
<li>
<code>maxRedirects</code> - the maximum number of redirects to follow, defaults to 10.</li>
<li>
<code>encoding</code> - Encoding to be used on <code>setEncoding</code> of response data. If set to <code>null</code>, the body is returned as a Buffer.</li>
<li>
<code>pool</code> - A hash object containing the agents for these requests. If omitted this request will use the global pool which is set to node's default maxSockets.</li>
<li>
<code>pool.maxSockets</code> - Integer containing the maximum amount of sockets in the pool.</li>
<li>
<code>timeout</code> - Integer containing the number of milliseconds to wait for a request to respond before aborting the request</li>
<li>
<code>proxy</code> - An HTTP proxy to be used. Support proxy Auth with Basic Auth the same way it's supported with the <code>url</code> parameter by embedding the auth info in the uri.</li>
<li>
<code>oauth</code> - Options for OAuth HMAC-SHA1 signing, see documentation above.</li>
<li>
<code>strictSSL</code> - Set to <code>true</code> to require that SSL certificates be valid. Note: to use your own certificate authority, you need to specify an agent that was created with that ca as an option.</li>
<li>
<code>jar</code> - Set to <code>false</code> if you don't want cookies to be remembered for future use or define your custom cookie jar (see examples section)</li>
<li>
<code>aws</code> - object containing aws signing information, should have the properties <code>key</code> and <code>secret</code> as well as <code>bucket</code> unless you're specifying your bucket as part of the path, or you are making a request that doesn't use a bucket (i.e. GET Services)</li>
</ul>

<div class="highlight highlight-javascript"><pre>request(app)
    .post(<span class="pl-s"><span class="pl-pds">"</span>/login<span class="pl-pds">"</span></span>)
    .<span class="pl-c1">form</span>({username <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>username<span class="pl-pds">"</span></span>, password <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>password<span class="pl-pds">"</span></span>})
    .expect(<span class="pl-c1">200</span>)
    .expect({loggedIn <span class="pl-k">:</span> <span class="pl-c1">true</span>})
    .end(<span class="pl-k">function</span>(<span class="pl-smi">err</span>){
        <span class="pl-k">if</span>(err){
            <span class="pl-k">throw</span> err;
        }
    });
</pre></div>

<p>To upload data to a server</p>

<div class="highlight highlight-javascript"><pre>request(app)
    .post(<span class="pl-s"><span class="pl-pds">"</span>/upload/csv<span class="pl-pds">"</span></span>)
    .<span class="pl-c1">headers</span>({<span class="pl-s"><span class="pl-pds">'</span>content-type<span class="pl-pds">'</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>multipart/form-data<span class="pl-pds">'</span></span>})
    .multipart([
        {
            <span class="pl-s"><span class="pl-pds">'</span>Content-Disposition<span class="pl-pds">'</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>form-data; name="file"; filename="my.csv"<span class="pl-pds">'</span></span>,
            <span class="pl-s"><span class="pl-pds">'</span>Content-Type<span class="pl-pds">'</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>text/csv<span class="pl-pds">'</span></span>,
            body<span class="pl-k">:</span> fs.readFileSync(path.resolve(<span class="pl-c1">__dirname</span>, <span class="pl-s"><span class="pl-pds">"</span>./assets/my.csv<span class="pl-pds">"</span></span>))
        }
    ])
    .expect(<span class="pl-c1">200</span>)
    .expect(<span class="pl-s"><span class="pl-pds">"</span>content-type<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>text/plain<span class="pl-pds">"</span></span>)
    .end(<span class="pl-k">function</span>(<span class="pl-smi">err</span>){
        <span class="pl-k">if</span>(err){
            <span class="pl-k">throw</span> err;
        }
    });
</pre></div>

<h3>
<a id="chaining-requests" class="anchor" href="#chaining-requests" aria-hidden="true"><span class="octicon octicon-link"></span></a>Chaining requests</h3>

<p><code>super-request</code> supports chaining of requests, this is particularly useful if you need to login to your server and then perform a request.</p>

<div class="highlight highlight-javascript"><pre>request(app)
    .post(<span class="pl-s"><span class="pl-pds">"</span>/login<span class="pl-pds">"</span></span>)
    .<span class="pl-c1">form</span>({username <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>username<span class="pl-pds">"</span></span>, password <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>password<span class="pl-pds">"</span></span>})
    .expect(<span class="pl-c1">200</span>)
    .expect({loggedIn <span class="pl-k">:</span> <span class="pl-c1">true</span>})
    .end() <span class="pl-c">//this request is done</span>
    <span class="pl-c">//now start a new one in the same session</span>
    .get(<span class="pl-s"><span class="pl-pds">"</span>/some/protected/route<span class="pl-pds">"</span></span>)
    .expect(<span class="pl-c1">200</span>, {hello <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>world<span class="pl-pds">"</span></span>})
    .end(<span class="pl-k">function</span>(<span class="pl-smi">err</span>){
        <span class="pl-k">if</span>(err){
            <span class="pl-k">throw</span> err;
        }
    });
</pre></div>

<p><strong>Note</strong> You must call end on the current request before you can start a new one.</p>

<h3>
<a id="simple-token-auth-example" class="anchor" href="#simple-token-auth-example" aria-hidden="true"><span class="octicon octicon-link"></span></a>Simple token-auth example</h3>

<p>Using everything learned above, let's try a more complex example.  This example illustrates using functions as the argument for your options.  This is useful for request chains that need to lazily evaluate a value returned from your http api.  Consider the extremely simplified example of a token authentication flow:</p>

<div class="highlight highlight-javascript"><pre><span class="pl-c">/**</span>
<span class="pl-c"> *  Webserver setup</span>
<span class="pl-c">**/</span>
<span class="pl-k">var</span> request <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>super-request<span class="pl-pds">'</span></span>),
    express <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>express<span class="pl-pds">'</span></span>),
    app <span class="pl-k">=</span> express();

app.use(express.bodyParser());
app.use(express.cookieParser());
app.use(express.cookieSession({secret<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>super-request123<span class="pl-pds">'</span></span>}));

<span class="pl-c">// a public available route, must post email/password to the body</span>
app.post(<span class="pl-s"><span class="pl-pds">'</span>/login<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> (<span class="pl-smi">req</span>, <span class="pl-smi">res</span>) {
    <span class="pl-k">var</span> body <span class="pl-k">=</span> req.<span class="pl-c1">body</span>;
    <span class="pl-k">if</span> (<span class="pl-k">!!</span>body.email <span class="pl-k">&amp;&amp;</span> <span class="pl-k">!!</span>body.password) {
        req.session.token <span class="pl-k">=</span> <span class="pl-c1">Math</span>.<span class="pl-c1">random</span>();
        res.<span class="pl-c1">send</span>(<span class="pl-s"><span class="pl-pds">'</span><span class="pl-pds">'</span></span><span class="pl-k">+</span>req.session.token);
    } <span class="pl-k">else</span> {
        res.<span class="pl-c1">send</span>(<span class="pl-c1">400</span>)
    }
});

<span class="pl-c">// a "private" route that requires a valid token in the query string.</span>
app.get(<span class="pl-s"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> (<span class="pl-smi">req</span>, <span class="pl-smi">res</span>) {
    <span class="pl-k">var</span> query <span class="pl-k">=</span> req.query <span class="pl-k">||</span> {};
    <span class="pl-k">if</span> (query.token <span class="pl-k">&amp;&amp;</span> <span class="pl-c1">parseFloat</span>(query.token) <span class="pl-k">===</span> req.session.token) {
        res.<span class="pl-c1">send</span>(<span class="pl-s"><span class="pl-pds">'</span>tokenValid<span class="pl-pds">'</span></span>);
    } <span class="pl-k">else</span> {
        res.<span class="pl-c1">send</span>(<span class="pl-c1">401</span>);
    }
});

<span class="pl-c">// create a request super-request</span>
<span class="pl-k">var</span> token;
request(app)
    .post(<span class="pl-s"><span class="pl-pds">'</span>/login<span class="pl-pds">'</span></span>)
    .<span class="pl-c1">form</span>({
        email<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>john@isp.com<span class="pl-pds">'</span></span>,
        password<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>pass1234<span class="pl-pds">'</span></span>
    })
    .expect(<span class="pl-c1">200</span>)
    .end(<span class="pl-k">function</span> (<span class="pl-smi">err</span>, <span class="pl-smi">res</span>, <span class="pl-smi">body</span>) {
        <span class="pl-c">// store the token, we will use it later in the request chain.</span>
        token <span class="pl-k">=</span> body;
    })
    <span class="pl-c">// after we have our token, adding the token to the query string gives access to protected routes</span>
    <span class="pl-c">// note: querystrings are an unsafe option for token auth in production, but works for a simple example.</span>
    .get(<span class="pl-s"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span>)
    .qs(<span class="pl-k">function</span> () {
        <span class="pl-k">return</span> {token<span class="pl-k">:</span> token};
    })
    .expect(<span class="pl-c1">200</span>, <span class="pl-s"><span class="pl-pds">'</span>tokenValid<span class="pl-pds">'</span></span>)
    .end()
    <span class="pl-c">// a request without a token or a bogus token protected routes cannot be reached.</span>
    .get(<span class="pl-s"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span>)
    .expect(<span class="pl-c1">401</span>)
    .end(<span class="pl-k">function</span>(<span class="pl-smi">err</span>){
        <span class="pl-k">if</span>(err){
            <span class="pl-k">throw</span> err;
        }
    });</pre></div>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/doug-martin/super-request">Super-request</a> is maintained by <a href="https://github.com/doug-martin">doug-martin</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>

